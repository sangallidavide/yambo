#!/usr/bin/perl
#
#        Copyright (C) 2000-2016 the YAMBO team
#              http://www.yambo-code.org
#
# Authors (see AUTHORS file for details): AM
#
# This file is distributed under the terms of the GNU
# General Public License. You can redistribute it and/or
# modify it under the terms of the GNU General Public
# License as published by the Free Software Foundation;
# either version 2, or (at your option) any later version.
#
# This program is distributed in the hope that it will
# be useful, but WITHOUT ANY WARRANTY; without even the
# implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
#
# You should have received a copy of the GNU General Public
# License along with this program; if not, write to the Free
# Software Foundation, Inc., 59 Temple Place - Suite 330,Boston,
# MA 02111-1307, USA or visit http://www.gnu.org/copyleft/gpl.txt.
#
# Based on the driver.pl written by Conor and (only partially) me
#
use Getopt::Long;
use File::Find;
use File::Copy;
use File::Basename;
use Time::HiRes qw(gettimeofday tv_interval);   # Not widely supported
use Cwd 'abs_path';
use Net::Domain qw(hostname hostfqdn hostdomain domainname);
#
# LIBS 
use lib "@srcdir_path@/lib/perl/ydb";
use print_the_run;
use database;
use load_db;
use objects_IO;
use create_new_run;
use functions;
use remove_run;
#
# Initialize
$version="2.0";
$awk=gawk;
#
# CMD line
&GetOptions("help"           => \$help,
            "m=s"            => \$material,
            "k=s"            => \$key,
            "desc=s"         => \$description,
            "id=i"           => \$ID_in,
            "if=i"           => \$IF_in,
            "i=s"            => \$input,
            "o=s"            => \$output,
            "d=s"            => \$database,
            "a"              => \$add,
            "c"              => \$create,
            "g"              => \$get,
            "del"            => \$del,
            "move"           => \$move,
            "u"              => \$update,
            "q"              => \$quiet,
            "r"              => \$rebuild,
            "t=s"            => \$user_tags,
            "list"           => \$list) or die;
sub usage {

 print <<EndOfUsage

   Syntax: ydb.pl [OPTIONS]

         [OPTIONS] are:
                   -h                      This help
                   -m      [STRING]        Material definition
                   -k      [key]           Key used to select specific groups of files
                   -desc   [DESC]          Run description
                   -id     [ID]            Run ID (father)
                   -ic     [ID]            Run ID (child)
                   -i      [FILE]          Input (not needed with -g) (also use all with -del)
                   -o      [FILE or DIR]   Output file/entire directory (not needed with -g) (also use all with -del)
                   -d      [FILE or DIR]   Database file/entire directory (not needed with -g) (also use all with -del)
                   -a                      Add to run ID (to be used together with -i/-o/-d)
                   -c                      Create the RUN
                   -g                      Get the run ID components (to be used together with -i/-o/-d)
                   -del                    Delete the run ID
                   -move   [OD]            Move the components of run ID to OD
                   -u                      Update local database
                   -q                      Quiet run (just list the actions)
                   -r                      Rebuild the database from the remote files list
                   -t      [tag1,tag2,...] Rebuild the database from the remote files list
                   -list                   List the content of the database (can be used with -k/-m/-i/-o/-d)

   [X] means X is requested
   <X> means X is optional

EndOfUsage
  ;
  exit;
}
#
# PATHS
my $cwd=abs_path();
$HOME="$ENV{HOME}";
#
# Date
@months = qw( Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec );
@days = qw(Sun Mon Tue Wed Thu Fri Sat Sun);
($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime();
$year=$year+1900;
$date="$mday-$mon-$year:$hour-$min";
#
# Help
if($help){ usage };
#
# DB conf
open(CONF,"<","$HOME/.ydb/configuration");
while(<CONF>) {
@words = split(' ',$_);
chomp($words);
if ("$words[0]" =~ "server"){$server=$words[1]};
if ("$words[0]" =~ "path"){$path=$words[1]};
};
close(CONF);
print "\n YdB version $version \n\n";
print   " Remote DB  \t$server:$path \n";
#
# Files (I)
$ACTIONS_sftp_file="$HOME/.ydb/todo_sftp";
$ACTIONS_ssh_file="$HOME/.ydb/todo_ssh";
$DB_file="$HOME/.ydb/database";
$n_to_remove=2;
$FILE_to_remove[1]="$ACTIONS_ssh_file";
$FILE_to_remove[2]="$ACTIONS_sftp_file";
#
# DB REBUILD
if ($rebuild)
{
# &local_cmd("ssh $server 'find $path > file_list'");
# &local_cmd("scp -qp $server:file_list $HOME/.ydb/file_list");
# &local_cmd("ssh $server 'rm -f file_list'");
 die "\n";
}
#
# DB UPDATE
if ($update or $create)
{
print " Local database synced with server...\n\n";
&local_cmd("scp -qp $server:$path/database $DB_file");
if (not $create) {exit;}
}
# Load DB components
&load_db();
#
# Input report
if ($user_tags) { 
 @tags= split(/\s*,\s*/, $user_tags); 
 print   " Tags\t\t:@tags\n" ;
};
if ($description) {print   " Description\t:$description \n"};
if ($input) {print   " Input      \t:$input \n"};
if ($output) {print   " Output(s) \t:$output \n"};
if ($database) {print " Database(s) \t:$database \n"};
#
# IRUN_in
if ($ID_in) { 
 $id_father=$ID_in;
 if ($IF_in) {$id_father=$IF_in};
 $IRUN_in=&have_run;
}
#
# LIST
if ($list) { 
 print   " DB elemets\t:$runs \n\n";
 $irun=0;
 while ($irun<$runs) {
  $irun++;
  &print_the_run($irun);
 } 
 exit;
};
#
# Files (II)
open(DB,">>","$DB_file");
open(ACTIONS_sftp,">","$ACTIONS_sftp_file");
open(ACTIONS_ssh,">","$ACTIONS_ssh_file");
#
# Material
if ($material) { print   " Material\t:$material \n" }
#
# ADD
if ($add and $ID_in) { &add_command_line_object } ;
#
# Remove
if ($del and $ID_in) { &remove_run } ;
#
# Get it
$test=&have_ID($ID_in);
if ($get and $ID_in and &have_ID($ID_in)==1) { 
 $local_dir="$cwd/$RUN_material[$IRUN_in]_ID_$ID_in";
 &local_cmd("mkdir -p $local_dir");
 if ($input)    {&local_cmd("mkdir -p $local_dir/inputs")};
 if ($output)   {&local_cmd("mkdir -p $local_dir/outputs")};
 if ($database) {&local_cmd("mkdir -p $local_dir/databases")};
 &get_the_run;
} ;
#
# CREATE
if ($create) { 
 if (!$material and !$ID_in) {die " A material must be provided\n"};
 &create_new_run();
};
#
# UPDATE
if ($ID_in){
 if ($quiet) {print "\n Changes in the database:\n\n"};
 if ($description) {&add_a_database_line($ID_in,"description","$description")};
 if ($material) {&add_a_database_line($ID_in,"material","$material")};
 if ($user_tags) {&add_a_database_line($ID_in,"tag","@tags")};
}
#
# SYNC
if ( ($create or ($ID_in and !$get) or $del ) and !$quiet )
{
 if (!$get) {&remote_sftp_cmd("put $DB_file $path/database")};
 close(DB);
 close(ACTIONS_sftp);
 close(ACTIONS_ssh);
 print "\n\n Running SFTP...\n\n";
 &local_cmd("sftp -q -b $ACTIONS_sftp_file $server");
 &local_cmd("ssh $server 'bash -s' < $ACTIONS_ssh_file");
}
#
# End
close(DB);
#
# Unzip/Dump local files
#
if ($get) {&local_uncompress};
#
# Delete Files
if ($quiet) { 
 print "\n\n ACTIONS to be done\n\n";
 &local_cmd("cat $ACTIONS_sftp_file");
 &local_cmd("cat $ACTIONS_ssh_file");
};
for($ik = 1; $ik <= $n_to_remove; $ik++) {
  unlink $FILE_to_remove[$ik] if exists($FILE_to_remove[$ik]);
};
#
print "\n\n";
#
exit;
#
sub remote_sftp_cmd 
#===================
{
foreach $command (@_) {
 print ACTIONS_sftp "$command\n";
 }
}
#
sub remote_ssh_cmd 
#===================
{
foreach $command (@_) {
 print ACTIONS_ssh "$command\n";
 }
}
sub local_cmd 
#=============
{
 foreach $command (@_) {
   $return_value = system("$command"); 
 }
}
